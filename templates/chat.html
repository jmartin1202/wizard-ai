<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Assistant">
    <title>QueryChats AI</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Global smooth transitions for theme switching */
        * {
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        border-color var(--transition-speed) var(--transition-ease),
                        box-shadow var(--transition-speed) var(--transition-ease);
        }

        :root {
            /* Dark Theme Colors - Obsidian Black */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-quaternary: #3a3a3a;
            
            /* Enhanced Minimalistic Colors - Obsidian */
            --dark-card-bg: rgba(26, 26, 26, 0.9);
            --dark-card-border: rgba(255, 255, 255, 0.08);
            --dark-card-shadow: rgba(0, 0, 0, 0.4);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            
            /* Enhanced Dark Mode Text Colors */
            --dark-text-primary: #ffffff;
            --dark-text-secondary: #e2e8f0;
            --dark-text-muted: #cbd5e1;
            --dark-text-accent: #fbbf24;
            
            /* Accent Colors */
            --accent-primary: #3B82F6;
            --accent-secondary: #a855f7;
            
            /* Enhanced Theme Colors */
            --dark-surface: #1a1a2e;
            --dark-surface-hover: #16213e;
            --dark-border: rgba(255, 255, 255, 0.1);
            --dark-shadow: rgba(0, 0, 0, 0.3);
            
            /* Smooth Transitions */
            --transition-speed: 0.3s;
            --transition-ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Obsidian Black Background - will be overridden by theme switching */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: -1;
            transition: background 0.3s ease;
        }

        body.light-mode::before {
            background: #ffffff;
        }

        body.light-mode {
            background: #ffffff;
            color: #212529;
        }

        body.light-mode .main-title {
            color: #212529;
        }

        body.light-mode .main-subtitle {
            color: #6c757d;
        }

        body.light-mode .input-field {
            background: #f8f9fa;
            border-color: #ced4da;
            color: #212529;
        }

        body.light-mode .input-field::placeholder {
            color: #6c757d;
        }

        body.light-mode .main-messages .message-content {
            background: #f8f9fa;
            border-color: #dee2e6;
            color: #212529;
        }

        body.light-mode .main-messages .message.user .message-content {
            background: #3B82F6;
            color: white;
        }

        body.light-mode .clear-chat-btn {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.2);
            color: rgba(0, 0, 0, 0.7);
        }

        body.light-mode .clear-chat-btn:hover {
            background: rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.3);
            color: rgba(0, 0, 0, 0.9);
        }







        /* Main Content Area */
        .main-content {
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            max-width: 800px;
            width: 100%;
            position: relative;
        }

        /* Header Container */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            position: relative;
        }

        .header-left {
            text-align: center;
            flex: 1;
        }

        .settings-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-radius: 50%;
            z-index: 1000;
        }

        .settings-icon:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-icon svg {
            width: 24px;
            height: 24px;
        }

        .main-title {
            font-size: 48px;
            font-weight: 400;
            margin-bottom: 16px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .main-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-weight: 400;
        }

        /* Main Messages Area */
        .main-messages {
            margin: 20px auto;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-messages .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
        }

        .main-messages .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .main-messages .avatar.user {
            background: var(--accent-primary);
            color: white;
        }

        .main-messages .avatar.ai {
            background: var(--accent-primary);
            color: white;
        }

        .main-messages .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 16px 20px;
            flex: 1;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .main-messages .message.user .message-content {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .main-messages .message.ai .message-content {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }



        /* Clear Chat Button */
        .clear-chat-container {
            text-align: center;
            margin: 15px 0 40px 0;
        }

        .clear-chat-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .clear-chat-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Input Container */
        .input-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin: 0 auto 40px auto;
        }

        .input-field {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 24px;
            padding: 16px 20px;
            padding-right: 120px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .input-field:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }



        .input-right-icons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .send-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .send-button:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }

        .voice-icon {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .voice-icon svg {
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .voice-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .file-upload-icon {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .file-upload-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .file-upload-icon svg {
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .tts-toggle {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .tts-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .tts-toggle.active {
            color: var(--accent-primary);
        }

        .tts-toggle svg {
            transition: all var(--transition-speed) var(--transition-ease);
        }

        /* Rich Media Content Styles */
        .rich-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rich-content img {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .rich-content img:hover {
            transform: scale(1.02);
        }

        .response-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-primary);
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .response-link:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        /* Document Upload Styles */
        .document-upload {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .document-upload strong {
            color: var(--accent-primary);
        }

        .document-upload small {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Language Detection Indicator */
        .language-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .language-indicator::before {
            content: '🌐';
            font-size: 10px;
        }

        /* Settings Modal Styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .settings-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--dark-border);
        }

        .settings-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .close-settings:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .settings-body {
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .setting-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-border);
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .voice-icon.listening {
            background: var(--accent-primary);
            color: white;
            animation: pulse-voice 1.5s infinite;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .voice-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .voice-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Image Preview Modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal.show {
            display: flex;
        }

        .image-preview-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--dark-border);
        }

        .image-preview-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
        }

        .close-preview {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .close-preview:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .image-preview-body {
            padding: 20px;
            text-align: center;
        }

        .image-preview-body img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .image-upload-info {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .image-upload-info p {
            margin: 8px 0;
        }

        .image-preview-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 20px;
            border-top: 1px solid var(--dark-border);
        }

        .remove-image-btn, .keep-image-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .remove-image-btn {
            background: #dc3545;
            color: white;
        }

        .remove-image-btn:hover {
            background: #c82333;
        }

        .keep-image-btn {
            background: var(--accent-primary);
            color: white;
        }

        .keep-image-btn:hover {
            background: var(--accent-secondary);
        }



        @keyframes pulse-voice {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }





                /* Chat Messages (Hidden by default) */
        .chat-container {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 64px;
            min-height: calc(100vh - 64px);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
        }



        .chat-header h2 {
            color: var(--text-primary);
            margin: 0;
        }

        .chat-messages {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
        }

        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .avatar.user {
            background: var(--accent-primary);
            color: white;
        }

        .avatar.ai {
            background: var(--accent-primary);
            color: white;
        }
        
        .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 16px 20px;
            color: var(--text-primary);
            flex: 1;
            word-wrap: break-word;
            line-height: 1.5;
            max-width: 100%;
        }

        .message.user .message-content {
            background: var(--accent-primary);
            color: white;
            border: none;
        }







        body.light-mode .message-content {
            background: #f8f9fa;
            border-color: #dee2e6;
            color: #212529;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .input-field {
                padding-right: 100px;
            }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }



        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 12px 16px;
            margin: 0 auto;
            max-width: 600px;
            width: 100%;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        .typing-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        /* Typing indicator within message content */
        .message-content.typing-indicator {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-content.typing-indicator .typing-dots {
            display: flex;
            gap: 3px;
        }

        .message-content.typing-indicator .typing-dots span {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .message-content.typing-indicator .typing-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        /* Real-time Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Real-time Message Animations */
        .message {
            animation: slideIn 0.3s ease-out;
        }

        .message.ai {
            animation: slideIn 0.4s ease-out;
        }

        /* Live Data Updates */
        .live-data {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            animation: fadeIn 0.5s ease-in;
        }

        .live-data.updating {
            background: rgba(255, 165, 0, 0.1);
            border-color: rgba(255, 165, 0, 0.3);
        }








    </style>
</head>
<body>
    <!-- Voice Status Indicator -->
    <div class="voice-status" id="voiceStatus">Listening...</div>
    

    
    <!-- Hidden File Input for Multiple File Types -->
    <input type="file" id="fileUploadInput" accept="image/*,.pdf,.doc,.docx,.txt,.md" style="display: none;" onchange="handleFileUpload(event)">
    


    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <div class="image-preview-content">
            <div class="image-preview-header">
                <h3>Image Preview</h3>
                <button class="close-preview" onclick="closeImagePreview()">×</button>
            </div>
            <div class="image-preview-body">
                <img id="previewImage" src="" alt="Preview">
                <div class="image-upload-info">
                    <p>Image uploaded successfully!</p>
                    <p>You can now ask questions about this image.</p>
                </div>
            </div>
            <div class="image-preview-actions">
                <button class="remove-image-btn" onclick="removeUploadedImage()">Remove Image</button>
                <button class="keep-image-btn" onclick="closeImagePreview()">Keep Image</button>
            </div>
        </div>
    </div>
    




            <!-- Main Content Area -->
        <div class="main-content">
            <div class="header-container">
                <div class="header-left">
                    <h1 class="main-title">Query AI</h1>
                    <p class="main-subtitle">Ask detailed questions for better responses</p>
                </div>
                <div class="settings-icon" onclick="console.log('Settings icon clicked!'); openSettings();" title="Settings" style="cursor: pointer;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="6" r="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <circle cx="12" cy="18" r="2"/>
                    </svg>
                </div>


            </div>
            
            <!-- Main Messages Area -->
            <div class="main-messages" id="mainMessages"></div>
            
            <!-- Input Container -->
            <div class="input-container">
                <input type="text" id="messageInput" class="input-field" placeholder="Ask anything" onkeypress="handleKeyPress(event)">
                <div class="input-right-icons">
                    <!-- File Upload Icon (Enhanced for multiple file types) -->
                    <div class="file-upload-icon" onclick="triggerFileUpload()" title="Upload Files (Images, Documents)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM16 18H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                        </svg>
                    </div>
                    <!-- Voice Input Icon -->
                    <div class="voice-icon" onclick="startVoiceInput()" title="Voice Input">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                    </div>
                    <!-- Text-to-Speech Toggle -->
                    <div class="tts-toggle" id="ttsToggle" onclick="toggleTTS()" title="Text-to-Speech (Off)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </div>
                    <button class="send-button" onclick="sendMessage()">↑</button>
                </div>
            </div>
            
            <!-- Clear Chat Button -->
            <div class="clear-chat-container">
                <button class="clear-chat-btn" onclick="clearChatHistory()" title="Clear conversation history">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13H5v-2h14v2z"/>
                    </svg>
                    Clear Chat
                </button>
            </div>
            <!-- Footer -->
        </div>

        <!-- Chat Container (Hidden by default) -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h2>Query AI Chat</h2>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="input-container">
            <input type="text" id="chatInput" class="input-field" placeholder="Ask anything" onkeypress="handleChatKeyPress(event)">
            <div class="input-right-icons">
                <div class="image-icon" onclick="triggerImageUpload()" title="Upload Image">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"/>
                    </svg>
                </div>
                <div class="voice-icon" onclick="startVoiceInput()" title="Voice Input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </div>
                <button class="send-button" onclick="sendChatMessage()">↑</button>
            </div>
        </div>
    </div>



    <script>
        // Global variables
        let useMemory = true;








        // Handle key press in main input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Handle key press in chat input
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }



        // Send message from chat input
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Send to AI with image if available
            if (uploadedImage && uploadedImageData) {
                sendToAIWithImage(message, uploadedImageData);
            } else {
                sendToAI(message);
            }
        }

        // Show chat view
        function showChatView() {
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
        }









        // Add message to main page
        function addMainMessage(content, isUser = false) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            // Add language detection for user messages
            if (isUser) {
                const detectedLang = detectLanguage(content);
                if (detectedLang !== 'english') {
                    const langIndicator = document.createElement('span');
                    langIndicator.className = 'language-indicator';
                    langIndicator.textContent = detectedLang;
                    messageDiv.appendChild(langIndicator);
                }
            }
            
            mainMessages.appendChild(messageDiv);
            
            // Scroll to bottom with smooth animation
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
            
            // Text-to-Speech for AI responses
            if (!isUser && ttsEnabled) {
                speakText(content);
            }
        }

        // Add rich media message with enhanced features
        function addRichMessage(content, isUser = false, mediaType = null, mediaData = null) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Handle rich media content
            if (mediaType === 'image' && mediaData) {
                messageContent.innerHTML = `
                    <div class="rich-content">
                        <img src="${mediaData}" alt="AI Response Image" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
                        <div class="text-content">${content}</div>
                    </div>
                `;
            } else if (mediaType === 'link' && mediaData) {
                messageContent.innerHTML = `
                    <div class="rich-content">
                        <div class="text-content">${content}</div>
                        <a href="${mediaData}" target="_blank" class="response-link">🔗 View Resource</a>
                    </div>
                `;
            } else {
                messageContent.textContent = content;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            mainMessages.appendChild(messageDiv);
            
            // Auto-scroll and speak if TTS is enabled
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
            
            if (!isUser && ttsEnabled) {
                speakText(content);
            }
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to AI with image
        async function sendToAIWithImage(message, imageData) {
            try {
                // Show loading message on main page
                addMainMessage('Analyzing image and processing your question...', false);
                
                const response = await fetch('/api/chat-with-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        image_data: imageData,
                        use_memory: useMemory
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.response) {
                        // Remove loading message and add AI response to main page
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage(data.response, false);
                    } else {
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
                    }
                } else {
                    const mainMessages = document.getElementById('mainMessages');
                    if (mainMessages.lastChild) {
                        mainMessages.removeChild(mainMessages.lastChild);
                    }
                    addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
                }
            } catch (error) {
                console.error('Error with image analysis:', error);
                const mainMessages = document.getElementById('mainMessages');
                if (mainMessages.lastChild) {
                    mainMessages.removeChild(mainMessages.lastChild);
                }
                addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
            }
        }

        // Send message to AI (using default GPT-4o)
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        personality: 'default',
                        use_memory: true,
                        provider: 'openai',
                        model: 'gpt-4o'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Send message to AI with document
        async function sendToAIWithDocument(message, documentData, documentName) {
            try {
                // Show loading message on main page
                addMainMessage('Analyzing document and processing your question...', false);
                
                const response = await fetch('/api/chat-with-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        document_data: documentData,
                        document_name: documentName,
                        use_memory: true
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.response) {
                        // Remove loading message and add AI response to main page
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage(data.response, false);
                    } else {
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage('Sorry, I encountered an error analyzing the document. Please try again.', false);
                    }
                } else {
                    const mainMessages = document.getElementById('mainMessages');
                    if (mainMessages.lastChild) {
                        mainMessages.removeChild(mainMessages.lastChild);
                    }
                    addMainMessage('Sorry, I encountered an error analyzing the document. Please try again.', false);
                }
            } catch (error) {
                console.error('Error with document analysis:', error);
                const mainMessages = document.getElementById('mainMessages');
                if (mainMessages.lastChild) {
                    mainMessages.removeChild(mainMessages.lastChild);
                }
                addMainMessage('Sorry, I encountered an error analyzing the document. Please try again.', false);
            }
        }

        // Voice input functionality
        let recognition = null;
        let isListening = false;

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                stopVoiceInput();
                return;
            }

            // Debug input fields before starting
            debugInputFields();

            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            
            // Auto-detect language or use user preference
            const userLang = localStorage.getItem('preferredLanguage') || 'en-US';
            recognition.lang = userLang;
            
            // Show language being used
            const langName = getLanguageName(userLang);
            showVoiceStatus(`Listening in ${langName}... Speak now!`);

            // Start listening
            recognition.start();
            isListening = true;
            updateVoiceIcon(true);
            showVoiceStatus('Listening... Speak now!');

            // Set up event handlers
            recognition.onstart = function() {
                console.log('Voice recognition started');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Voice input:', transcript);
                
                // Determine which input field should receive the transcript
                let targetInput = null;
                
                // Check if we're in chat view or main view
                const chatContainer = document.getElementById('chatContainer');
                const mainContent = document.querySelector('.main-content');
                
                if (chatContainer && chatContainer.style.display !== 'none') {
                    // We're in chat view, use chatInput
                    targetInput = document.getElementById('chatInput');
                } else if (mainContent && mainContent.style.display !== 'none') {
                    // We're in main view, use messageInput
                    targetInput = document.getElementById('messageInput');
                }
                
                // If we found a target input, fill it with the transcript
                if (targetInput) {
                    targetInput.value = transcript;
                    targetInput.focus(); // Focus the input field
                    showVoiceStatus(`"${transcript}" - Ready to send!`);
                    console.log('Transcript added to:', targetInput.id);
                } else {
                    console.error('No target input found for transcript');
                    showVoiceStatus('Error: Could not find input field');
                }
                
                // Stop listening
                stopVoiceInput();
            };

            recognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);
                let errorMessage = 'Voice recognition error';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'No speech detected. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microphone not accessible. Please check permissions.';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied. Please allow microphone access.';
                        break;
                    default:
                        errorMessage = `Voice recognition error: ${event.error}`;
                }
                
                showVoiceStatus(errorMessage);
                stopVoiceInput();
            };

            recognition.onend = function() {
                console.log('Voice recognition ended');
                stopVoiceInput();
            };
        }

        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            isListening = false;
            updateVoiceIcon(false);
        }

        function updateVoiceIcon(listening) {
            const voiceIcons = document.querySelectorAll('.voice-icon');
            voiceIcons.forEach(icon => {
                if (listening) {
                    icon.classList.add('listening');
                    // Replace SVG with red dot when listening
                    icon.innerHTML = '<div style="width: 12px; height: 12px; background: white; border-radius: 50%;"></div>';
                } else {
                    icon.classList.remove('listening');
                    // Restore SVG icon when not listening
                    icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';
                }
            });
        }

        function showVoiceStatus(message) {
            const status = document.getElementById('voiceStatus');
            status.textContent = message;
            status.classList.add('show');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        function hideVoiceStatus() {
            const status = document.getElementById('voiceStatus');
            status.classList.remove('show');
        }

        // Image upload functionality
        // Variables are declared globally below

        function triggerImageUpload() {
            document.getElementById('imageUploadInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Image file size must be less than 10MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = file;
                uploadedImageData = e.target.result;
                
                // Show image preview
                document.getElementById('previewImage').src = uploadedImageData;
                document.getElementById('imagePreviewModal').classList.add('show');
                
                // Update input placeholder to indicate image is ready
                updateInputPlaceholders();
                
                console.log('Image uploaded:', file.name, file.size, 'bytes');
            };
            reader.readAsDataURL(file);
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('show');
        }

        function removeUploadedImage() {
            uploadedImage = null;
            uploadedImageData = null;
            document.getElementById('imageUploadInput').value = '';
            document.getElementById('imagePreviewModal').classList.remove('show');
            updateInputPlaceholders();
            console.log('Image removed');
        }

        function updateInputPlaceholders() {
            const messageInput = document.getElementById('messageInput');
            const chatInput = document.getElementById('chatInput');
            
            if (uploadedImage) {
                const placeholder = `Ask about the uploaded image... (${uploadedImage.name})`;
                if (messageInput) messageInput.placeholder = placeholder;
                if (chatInput) chatInput.placeholder = placeholder;
            } else {
                if (messageInput) messageInput.placeholder = 'Ask anything';
                if (chatInput) chatInput.placeholder = 'Ask anything';
            }
        }

        // Pixel Dog Interactions
        function initPixelDog() {
            const dog = document.getElementById('pixelDog');
            const speechBubble = document.getElementById('dogSpeechBubble');
            
            // Make dog interactive
            dog.style.pointerEvents = 'auto';
            dog.style.cursor = 'pointer';
            
            // Dog click interactions
            dog.addEventListener('click', function() {
                // Random dog reactions
                const reactions = [
                    'Woof! 🐕',
                    'Happy to see you! 🐾',
                    'Want to play? 🎾',
                    'Good human! 👋',
                    'Sniff sniff... 👃'
                ];
                
                const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
                speechBubble.querySelector('.bubble-text').textContent = randomReaction;
                
                // Add excitement animation
                dog.style.animation = 'dog-bounce 0.5s ease-in-out 3';
                setTimeout(() => {
                    dog.style.animation = 'dog-bounce 3s ease-in-out infinite';
                }, 1500);
                
                // Reset to original message after 3 seconds
                setTimeout(() => {
                    speechBubble.querySelector('.bubble-text').textContent = 'Thank you for visiting my app! 🐕✨';
                }, 3000);
            });
            
            // Dog hover effects
            dog.addEventListener('mouseenter', function() {
                dog.style.transform = 'scale(1.1)';
                speechBubble.style.transform = 'scale(1.05)';
            });
            
            dog.addEventListener('mouseleave', function() {
                dog.style.transform = 'scale(1)';
                speechBubble.style.transform = 'scale(1)';
            });
        }

        // Debug function to check input field states
        function debugInputFields() {
            const chatContainer = document.getElementById('chatContainer');
            const mainContent = document.querySelector('.main-content');
            const chatInput = document.getElementById('chatInput');
            const messageInput = document.getElementById('messageInput');
            
            console.log('=== Input Field Debug ===');
            console.log('Chat container display:', chatContainer ? chatContainer.style.display : 'not found');
            console.log('Main content display:', mainContent ? mainContent.style.display : 'not found');
            console.log('Chat input exists:', !!chatInput);
            console.log('Message input exists:', !!messageInput);
            console.log('Chat input value:', chatInput ? chatInput.value : 'N/A');
            console.log('Message input value:', messageInput ? messageInput.value : 'N/A');
            console.log('========================');
        }

        // Test backend connection
        async function testBackend() {
            try {
                const response = await fetch('/debug');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend test successful:', data);
                    return true;
                } else {
                    console.error('Backend test failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Backend test error:', error);
                return false;
            }
        }

        // Send message to AI (using default GPT-4o)
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        personality: 'default',
                        use_memory: true,
                        provider: 'openai',
                        model: 'gpt-4o'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Send message to AI with image (using default GPT-4o)
        async function sendToAIWithImage(message, imageData) {
            try {
                const response = await fetch('/api/chat-with-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        image_data: imageData,
                        personality: 'default',
                        use_memory: true
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                    
                    // Real-time model info for image analysis
                    const modelInfo = document.createElement('div');
                    modelInfo.className = 'model-indicator';
                    modelInfo.innerHTML = `
                        <small style="color: #3B82F6; font-size: 12px; opacity: 0.8;">
                            Powered by GPT-4o (Image Analysis) • ${data.tokens_used || 0} tokens
                        </small>
                    `;
                    
                    const lastMessage = document.querySelector('.main-messages .message.ai:last-child');
                    if (lastMessage) {
                        lastMessage.appendChild(modelInfo);
                    }
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded!'); // Debug log
            // Test backend connection
            testBackend();
            
            // Test if settings function is available
            if (typeof openSettings === 'function') {
                console.log('openSettings function is available!');
            } else {
                console.error('openSettings function is NOT available!');
            }
            
            // Force refresh theme on page load
            setTimeout(() => {
                const currentTheme = localStorage.getItem('theme') || 'dark';
                console.log('Applying theme on load:', currentTheme);
                applyTheme(currentTheme);
                
                // Apply current TTS setting
                const currentTTS = localStorage.getItem('ttsEnabled') === 'true';
                updateTTS(currentTTS);
            }, 100);
        });

        // Real-time Updates System





        function updateLiveData() {
            // Keep this function for future use but don't auto-fetch data
            // Data will be fetched when users ask specific questions
        }





        // Clear Chat History
        function clearChatHistory() {
            const mainMessages = document.getElementById('mainMessages');
            mainMessages.innerHTML = '';
        }

        // Typing Indicator Functions
        function showTypingIndicator() {
            const mainMessages = document.getElementById('mainMessages');
            
            // Create typing indicator as an AI message
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing-message';
            typingDiv.id = 'typingMessage';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar ai';
            avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                <!-- Robot Head -->
                <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                <!-- Eyes -->
                <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                <!-- Smiling Mouth -->
                <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                <!-- Headset Band -->
                <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                <!-- Earcups -->
                <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                <!-- Microphone -->
                <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                <!-- Antenna -->
                <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
            </svg>`;
            
            const typingContent = document.createElement('div');
            typingContent.className = 'message-content typing-indicator';
            typingContent.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">AI is thinking...</span>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            mainMessages.appendChild(typingDiv);
            
            // Scroll to bottom
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        function hideTypingIndicator() {
            const typingMessage = document.getElementById('typingMessage');
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        // Enhanced Message Functions with Real-time Features
        function addMainMessage(content, isUser = false) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            mainMessages.appendChild(messageDiv);
            
            // Real-time scroll with smooth animation
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
            

        }

        // Enhanced Send Message with Real-time Features
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to main page (keep conversation history)
            addMainMessage(message, true);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send to AI with appropriate context
            if (uploadedImage && uploadedImageData) {
                await sendToAIWithImage(message, uploadedImageData);
            } else if (uploadedDocument && uploadedDocumentData) {
                await sendToAIWithDocument(message, uploadedDocumentData, uploadedDocument.name);
            } else {
                await sendToAI(message);
            }
            
            // Hide typing indicator
            hideTypingIndicator();
        }



        // Comprehensive Settings Tab Function
        function openSettings() {
            console.log('Opening comprehensive settings tab...');
            
            // Get current settings from localStorage
            const currentSettings = {
                botName: localStorage.getItem('botName') || 'Query AI',
                botDescription: localStorage.getItem('botDescription') || 'Your intelligent AI assistant',
                apiKey: localStorage.getItem('apiKey') || '',
                selectedModel: localStorage.getItem('selectedModel') || 'gpt-4o',
                creativityLevel: localStorage.getItem('creativityLevel') || '0.7',
                theme: localStorage.getItem('theme') || 'dark',
                language: localStorage.getItem('preferredLanguage') || 'en-US',
                ttsEnabled: localStorage.getItem('ttsEnabled') === 'true',
                maxTokens: localStorage.getItem('maxTokens') || '1000',
                timeout: localStorage.getItem('timeout') || '30',
                autoSave: localStorage.getItem('autoSave') !== 'false',
                dataRetention: localStorage.getItem('dataRetention') || '30'
            };
            
            // Create the comprehensive settings modal
            const settingsHTML = `
                <div id="settingsModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    overflow-y: auto;
                    padding: 20px;
                ">
                    <div style="
                        background: #1a1a1a;
                        border: 1px solid #333;
                        border-radius: 20px;
                        max-width: 800px;
                        width: 100%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8);
                        position: relative;
                    ">
                        <!-- Header -->
                        <div style="
                            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
                            padding: 25px 30px;
                            border-bottom: 1px solid #333;
                            border-radius: 20px 20px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        ">
                            <div>
                                <h1 style="margin: 0; color: white; font-size: 24px; font-weight: 600;">⚙️ Settings</h1>
                                <p style="margin: 5px 0 0 0; color: #888; font-size: 14px;">Customize your AI assistant experience</p>
                            </div>
                            <button onclick="closeSettings()" style="
                                background: rgba(255, 255, 255, 0.1);
                                border: 1px solid #444;
                                color: #888;
                                font-size: 20px;
                                cursor: pointer;
                                padding: 8px;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">×</button>
                        </div>
                        
                        <!-- Settings Content -->
                        <div style="padding: 30px;">
                            <!-- Appearance & Theme Section -->
                            <div style="margin-bottom: 40px;">
                                <h3 style="color: white; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center;">
                                    🎨 Appearance & Theme
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 500;">Theme</label>
                                        <select id="theme" onchange="updateSetting('theme', this.value)" style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #444;
                                            border-radius: 8px;
                                            background: #2a2a2a;
                                            color: white;
                                            font-size: 14px;
                                        ">
                                            <option value="dark" ${currentSettings.theme === 'dark' ? 'selected' : ''}>Dark Theme</option>
                                            <option value="light" ${currentSettings.theme === 'light' ? 'selected' : ''}>Light Theme</option>
                                            <option value="auto" ${currentSettings.theme === 'auto' ? 'selected' : ''}>Auto (System)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 500;">Language</label>
                                        <select id="language" onchange="updateSetting('preferredLanguage', this.value)" style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #444;
                                            border-radius: 8px;
                                            background: #2a2a2a;
                                            color: white;
                                            font-size: 14px;
                                        ">
                                            <option value="en-US" ${currentSettings.language === 'en-US' ? 'selected' : ''}>English</option>
                                            <option value="es-ES" ${currentSettings.language === 'es-ES' ? 'selected' : ''}>Spanish</option>
                                            <option value="fr-FR" ${currentSettings.language === 'fr-FR' ? 'selected' : ''}>French</option>
                                            <option value="de-DE" ${currentSettings.language === 'de-DE' ? 'selected' : ''}>German</option>
                                            <option value="it-IT" ${currentSettings.language === 'it-IT' ? 'selected' : ''}>Italian</option>
                                            <option value="pt-BR" ${currentSettings.language === 'pt-BR' ? 'selected' : ''}>Portuguese</option>
                                            <option value="ru-RU" ${currentSettings.language === 'ru-RU' ? 'selected' : ''}>Russian</option>
                                            <option value="zh-CN" ${currentSettings.language === 'zh-CN' ? 'selected' : ''}>Chinese</option>
                                            <option value="ja-JP" ${currentSettings.language === 'ja-JP' ? 'selected' : ''}>Japanese</option>
                                            <option value="ko-KR" ${currentSettings.language === 'ko-KR' ? 'selected' : ''}>Korean</option>
                                            <option value="ar-SA" ${currentSettings.language === 'ar-SA' ? 'selected' : ''}>Arabic</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Features Section -->
                            <div style="margin-bottom: 40px;">
                                <h3 style="color: white; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center;">
                                    ✨ Features
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label style="display: flex; align-items: center; color: white; margin-bottom: 8px; font-weight: 500; cursor: pointer;">
                                            <input type="checkbox" id="ttsEnabled" ${currentSettings.ttsEnabled ? 'checked' : ''} onchange="updateSetting('ttsEnabled', this.checked)" style="
                                                margin-right: 10px;
                                                transform: scale(1.2);
                                            ">
                                            Text-to-Speech
                                        </label>
                                        <small style="color: #888; font-size: 12px;">Enable AI voice responses</small>
                                    </div>
                                    <div>
                                        <label style="display: flex; align-items: center; color: white; margin-bottom: 8px; font-weight: 500; cursor: pointer;">
                                            <input type="checkbox" id="autoSave" ${currentSettings.autoSave ? 'checked' : ''} onchange="updateSetting('autoSave', this.checked)" style="
                                                margin-right: 10px;
                                                transform: scale(1.2);
                                            ">
                                            Auto-save Conversations
                                        </label>
                                        <small style="color: #888; font-size: 12px;">Automatically save chat history</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 40px;">
                                <button onclick="saveAllSettings()" style="
                                    background: #3B82F6;
                                    color: white;
                                    border: none;
                                    padding: 15px 30px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 16px;
                                    font-weight: 600;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3B82F6'">
                                    💾 Save All Settings
                                </button>
                                <button onclick="resetToDefaults()" style="
                                    background: #6b7280;
                                    color: white;
                                    border: none;
                                    padding: 15px 30px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 16px;
                                    font-weight: 600;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                                    🔄 Reset to Defaults
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('settingsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', settingsHTML);
            
            console.log('Comprehensive settings modal created successfully!');
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.remove();
            }
        }

        function toggleTTSFromSettings(enabled) {
            ttsEnabled = enabled;
            const ttsToggle = document.getElementById('ttsToggle');
            
            if (enabled) {
                ttsToggle.classList.add('active');
                ttsToggle.title = 'Text-to-Speech (On)';
                ttsToggle.style.color = 'var(--accent-primary)';
            } else {
                ttsToggle.classList.remove('active');
                ttsToggle.title = 'Text-to-Speech (Off)';
                ttsToggle.style.color = 'var(--text-secondary)';
            }
        }

        // Enhanced File Upload Function (supports multiple file types)
        function triggerFileUpload() {
            document.getElementById('fileUploadInput').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileType = file.type;
            const fileName = file.name;

            if (fileType.startsWith('image/')) {
                // Handle image files
                handleImageFile(file);
            } else if (fileType === 'application/pdf' || 
                       fileType.includes('document') || 
                       fileType === 'text/plain' || 
                       fileType === 'text/markdown') {
                // Handle document files
                handleDocumentFile(file);
            } else {
                alert('Unsupported file type. Please upload images, PDFs, or text documents.');
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = file;
                uploadedImageData = e.target.result;
                showImagePreview(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }

        function handleDocumentFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store document data for AI processing
                uploadedDocument = file;
                uploadedDocumentData = e.target.result;
                showDocumentPreview(file.name);
            };
            reader.readAsText(file);
        }

        function showDocumentPreview(fileName) {
            // Show document upload confirmation
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="avatar user">📄</div>
                <div class="message-content">
                    <strong>Document uploaded:</strong> ${fileName}<br>
                    <small>You can now ask questions about this document.</small>
                </div>
            `;
            mainMessages.appendChild(messageDiv);
            mainMessages.scrollTop = mainMessages.scrollHeight;
        }

        // Text-to-Speech Functionality
        // Variables are declared globally below
        let speechSynthesis = window.speechSynthesis;

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            const ttsToggle = document.getElementById('ttsToggle');
            
            if (ttsEnabled) {
                ttsToggle.classList.add('active');
                ttsToggle.title = 'Text-to-Speech (On)';
                ttsToggle.style.color = 'var(--accent-primary)';
            } else {
                ttsToggle.classList.remove('active');
                ttsToggle.title = 'Text-to-Speech (Off)';
                ttsToggle.style.color = 'var(--text-secondary)';
            }
        }

        function speakText(text) {
            if (!ttsEnabled) return;
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
        }

        // Multi-language Support
        function detectLanguage(text) {
            // Simple language detection (can be enhanced with libraries)
            const patterns = {
                'spanish': /[áéíóúñ¿¡]/i,
                'french': /[àâäéèêëïîôùûüÿç]/i,
                'german': /[äöüß]/i,
                'italian': /[àèéìíîòóù]/i,
                'portuguese': /[ãâáàçéêíóôõú]/i,
                'russian': /[а-яё]/i,
                'chinese': /[\u4e00-\u9fff]/i,
                'japanese': /[\u3040-\u309f\u30a0-\u30ff]/i,
                'korean': /[\uac00-\ud7af]/i,
                'arabic': /[\u0600-\u06ff]/i
            };

            for (const [lang, pattern] of Object.entries(patterns)) {
                if (pattern.test(text)) {
                    return lang;
                }
            }
            return 'english';
        }

        function getLanguageName(langCode) {
            const languages = {
                'en-US': 'English',
                'es-ES': 'Spanish',
                'fr-FR': 'French',
                'de-DE': 'German',
                'it-IT': 'Italian',
                'pt-BR': 'Portuguese',
                'ru-RU': 'Russian',
                'zh-CN': 'Chinese',
                'ja-JP': 'Japanese',
                'ko-KR': 'Korean',
                'ar-SA': 'Arabic'
            };
            return languages[langCode] || 'English';
        }

        function setLanguagePreference(langCode) {
            localStorage.setItem('preferredLanguage', langCode);
            // Update voice recognition language if currently listening
            if (recognition && isListening) {
                recognition.lang = langCode;
                const langName = getLanguageName(langCode);
                showVoiceStatus(`Switched to ${langName}... Speak now!`);
            }
        }

        // Enhanced message display with rich media support
        function addRichMessage(content, isUser = false, mediaType = null, mediaData = null) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="12" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Handle rich media content
            if (mediaType === 'image' && mediaData) {
                messageContent.innerHTML = `
                    <div class="rich-content">
                        <img src="${mediaData}" alt="AI Response Image" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
                        <div class="text-content">${content}</div>
                    </div>
                `;
            } else if (mediaType === 'link' && mediaData) {
                messageContent.innerHTML = `
                    <div class="rich-content">
                        <div class="text-content">${content}</div>
                        <a href="${mediaData}" target="_blank" class="response-link">🔗 View Resource</a>
                    </div>
                `;
            } else {
                messageContent.textContent = content;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            mainMessages.appendChild(messageDiv);
            
            // Auto-scroll and speak if TTS is enabled
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
            
            if (!isUser && ttsEnabled) {
                speakText(content);
            }
        }

        // Global variables for file handling
        let uploadedImage = null;
        let uploadedImageData = null;
        let uploadedDocument = null;
        let uploadedDocumentData = null;

        // Debug: Test if functions are defined
        console.log('Script loaded!');
        console.log('openSettings function exists:', typeof openSettings);
        console.log('closeSettings function exists:', typeof closeSettings);
        console.log('ttsEnabled variable exists:', typeof ttsEnabled !== 'undefined');

        // Supporting functions for the comprehensive settings tab
        function updateSetting(key, value) {
            localStorage.setItem(key, value);
            console.log(`Setting updated: ${key} = ${value}`);
            
            // Apply immediate changes for certain settings
            switch(key) {
                case 'botName':
                    updateBotName(value);
                    break;
                case 'theme':
                    forceThemeRefresh(value);
                    break;
                case 'preferredLanguage':
                    setLanguagePreference(value);
                    break;
                case 'ttsEnabled':
                    updateTTS(value);
                    break;
            }
        }
        
        function updateBotName(name) {
            const titleElement = document.querySelector('.main-title');
            if (titleElement) {
                titleElement.textContent = name;
            }
        }
        
        function applyTheme(theme) {
            // Remove existing theme classes
            document.body.classList.remove('dark', 'light');
            
            if (theme === 'auto') {
                // Auto theme based on system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.body.classList.add(prefersDark ? 'dark' : 'light');
            } else {
                document.body.classList.add(theme);
            }
            
            // Update the entire app theme
            const isDark = document.body.classList.contains('dark');
            
            if (isDark) {
                // Dark theme - apply dark styles
                document.body.style.background = '#0a0a0a';
                document.body.style.color = '#ffffff';
                
                // Update main content colors
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.color = '#ffffff';
                }
                
                // Update title colors
                const mainTitle = document.querySelector('.main-title');
                if (mainTitle) {
                    mainTitle.style.color = '#ffffff';
                }
                
                const mainSubtitle = document.querySelector('.main-subtitle');
                if (mainSubtitle) {
                    mainSubtitle.style.color = 'rgba(255, 255, 255, 0.9)';
                }
                
                // Update input field colors
                const inputFields = document.querySelectorAll('.input-field');
                inputFields.forEach(field => {
                    field.style.background = '#2a2a2a';
                    field.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    field.style.color = '#ffffff';
                });
                
                // Update message colors
                const messageContents = document.querySelectorAll('.message-content');
                messageContents.forEach(msg => {
                    if (!msg.classList.contains('user')) {
                        msg.style.background = '#2a2a2a';
                        msg.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                        msg.style.color = '#ffffff';
                    }
                });
                
                // Update clear chat button
                const clearChatBtn = document.querySelector('.clear-chat-btn');
                if (clearChatBtn) {
                    clearChatBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                    clearChatBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    clearChatBtn.style.color = 'rgba(255, 255, 255, 0.7)';
                }
                
            } else {
                // Light theme - apply light styles
                document.body.style.background = '#ffffff';
                document.body.style.color = '#212529';
                
                // Update main content colors
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.color = '#212529';
                }
                
                // Update title colors
                const mainTitle = document.querySelector('.main-title');
                if (mainTitle) {
                    mainTitle.style.color = '#212529';
                }
                
                const mainSubtitle = document.querySelector('.main-subtitle');
                if (mainSubtitle) {
                    mainSubtitle.style.color = '#6c757d';
                }
                
                // Update input field colors
                const inputFields = document.querySelectorAll('.input-field');
                inputFields.forEach(field => {
                    field.style.background = '#f8f9fa';
                    field.style.borderColor = '#ced4da';
                    field.style.color = '#212529';
                });
                
                // Update message colors
                const messageContents = document.querySelectorAll('.message-content');
                messageContents.forEach(msg => {
                    if (!msg.classList.contains('user')) {
                        msg.style.background = '#f8f9fa';
                        msg.style.borderColor = '#dee2e6';
                        msg.style.color = '#212529';
                    }
                });
                
                // Update clear chat button
                const clearChatBtn = document.querySelector('.clear-chat-btn');
                if (clearChatBtn) {
                    clearChatBtn.style.background = 'rgba(0, 0, 0, 0.1)';
                    clearChatBtn.style.borderColor = 'rgba(0, 0, 0, 0.2)';
                    clearChatBtn.style.color = 'rgba(0, 0, 0, 0.7)';
                }
            }
            
            // Update settings modal colors based on theme
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                const modalContent = settingsModal.querySelector('div > div');
                const modalHeader = modalContent.querySelector('div:first-child');
                const modalBody = modalContent.querySelector('div:last-child');
                
                if (isDark) {
                    // Dark theme
                    modalContent.style.background = '#1a1a1a';
                    modalHeader.style.background = 'linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%)';
                    modalHeader.style.borderBottom = '1px solid #333';
                    
                    // Update text colors for dark theme
                    const labels = modalBody.querySelectorAll('label');
                    const headings = modalBody.querySelectorAll('h3');
                    labels.forEach(label => label.style.color = 'white');
                    headings.forEach(heading => heading.style.color = 'white');
                    
                    // Update select backgrounds
                    const selects = modalBody.querySelectorAll('select');
                    selects.forEach(select => {
                        select.style.background = '#2a2a2a';
                        select.style.color = 'white';
                        select.style.borderColor = '#444';
                    });
                    
                    // Update small text
                    const smallTexts = modalBody.querySelectorAll('small');
                    smallTexts.forEach(small => small.style.color = '#888');
                } else {
                    // Light theme
                    modalContent.style.background = '#ffffff';
                    modalHeader.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                    modalHeader.style.borderBottom = '1px solid #dee2e6';
                    
                    // Update text colors for light theme
                    const labels = modalBody.querySelectorAll('label');
                    const headings = modalBody.querySelectorAll('h3');
                    labels.forEach(label => label.style.color = '#212529');
                    headings.forEach(heading => heading.style.color = '#212529');
                    
                    // Update select backgrounds
                    const selects = modalBody.querySelectorAll('select');
                    selects.forEach(select => {
                        select.style.background = '#ffffff';
                        select.style.color = '#212529';
                        select.style.borderColor = '#ced4da';
                    });
                    
                    // Update small text
                    const smallTexts = modalBody.querySelectorAll('small');
                    smallTexts.forEach(small => small.style.color = '#6c757d');
                }
            }
        }
        
        function updateTTS(enabled) {
            ttsEnabled = enabled;
            const ttsToggle = document.getElementById('ttsToggle');
            if (ttsToggle) {
                if (enabled) {
                    ttsToggle.classList.add('active');
                    ttsToggle.title = 'Text-to-Speech (On)';
                    ttsToggle.style.color = 'var(--accent-primary)';
                } else {
                    ttsToggle.classList.remove('active');
                    ttsToggle.title = 'Text-to-Speech (Off)';
                    ttsToggle.style.color = 'var(--text-secondary)';
                }
            }
        }
        
        function saveAllSettings() {
            // Collect all current values from the form
            const settings = {
                theme: document.getElementById('theme').value,
                language: document.getElementById('language').value,
                ttsEnabled: document.getElementById('ttsEnabled').checked,
                autoSave: document.getElementById('autoSave').checked
            };
            
            // Save all settings to localStorage
            Object.entries(settings).forEach(([key, value]) => {
                localStorage.setItem(key === 'language' ? 'preferredLanguage' : key, value);
            });
            
            // Apply all changes
            applyTheme(settings.theme);
            updateTTS(settings.ttsEnabled);
            
            // Show success message
            showNotification('✅ All settings saved successfully!', 'success');
            
            console.log('All settings saved:', settings);
        }
        
        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                // Clear all custom settings
                const keysToRemove = [
                    'theme', 'preferredLanguage', 'ttsEnabled', 'autoSave'
                ];
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // Reset form values
                const defaultSettings = {
                    theme: 'dark',
                    language: 'en-US',
                    ttsEnabled: false,
                    autoSave: true
                };
                
                // Update form fields
                Object.entries(defaultSettings).forEach(([key, value]) => {
                    const element = document.getElementById(key === 'preferredLanguage' ? 'language' : key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
                
                // Apply default changes
                applyTheme(defaultSettings.theme);
                updateTTS(defaultSettings.ttsEnabled);
                
                showNotification('🔄 Settings reset to defaults!', 'info');
                console.log('Settings reset to defaults');
            }
        }
        
        function clearAllData() {
            if (confirm('⚠️ WARNING: This will permanently delete ALL your chat history, settings, and data. This action cannot be undone. Are you absolutely sure?')) {
                // Clear all localStorage
                localStorage.clear();
                
                // Clear chat history
                const mainMessages = document.getElementById('mainMessages');
                if (mainMessages) {
                    mainMessages.innerHTML = '';
                }
                
                // Reset to defaults
                resetToDefaults();
                
                showNotification('🗑️ All data cleared successfully!', 'warning');
                console.log('All data cleared');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function forceThemeRefresh(theme) {
            // Remove the CSS pseudo-element background
            const style = document.createElement('style');
            style.id = 'theme-override';
            style.textContent = `
                body::before {
                    background: ${theme === 'light' ? '#ffffff' : '#0a0a0a'} !important;
                }
            `;
            
            // Remove existing override
            const existingOverride = document.getElementById('theme-override');
            if (existingOverride) {
                existingOverride.remove();
            }
            
            // Add new override
            document.head.appendChild(style);
            
            // Apply theme
            applyTheme(theme);
        }
    </script>
</body>
</html>
