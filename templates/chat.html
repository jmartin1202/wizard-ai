<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Assistant">
    <title>QueryChats AI</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Global smooth transitions for theme switching */
        * {
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        border-color var(--transition-speed) var(--transition-ease),
                        box-shadow var(--transition-speed) var(--transition-ease);
        }

        :root {
            /* Dark Theme Colors - Obsidian Black */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-quaternary: #3a3a3a;
            
            /* Enhanced Minimalistic Colors - Obsidian */
            --dark-card-bg: rgba(26, 26, 26, 0.9);
            --dark-card-border: rgba(255, 255, 255, 0.08);
            --dark-card-shadow: rgba(0, 0, 0, 0.4);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            
            /* Enhanced Dark Mode Text Colors */
            --dark-text-primary: #ffffff;
            --dark-text-secondary: #e2e8f0;
            --dark-text-muted: #cbd5e1;
            --dark-text-accent: #fbbf24;
            
            /* Accent Colors */
            --accent-primary: #3B82F6;
            --accent-secondary: #a855f7;
            
            /* Enhanced Theme Colors */
            --dark-surface: #1a1a2e;
            --dark-surface-hover: #16213e;
            --dark-border: rgba(255, 255, 255, 0.1);
            --dark-shadow: rgba(0, 0, 0, 0.3);
            
            /* Smooth Transitions */
            --transition-speed: 0.3s;
            --transition-ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Obsidian Black Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: -1;
        }



        body.light-mode {
            background: var(--light-bg-primary);
            color: var(--light-text-primary);
        }







        /* Main Content Area */
        .main-content {
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            max-width: 800px;
            width: 100%;
            position: relative;
        }

        /* Header Container */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            position: relative;
        }

        .header-left {
            text-align: left;
            flex: 1;
        }

        .settings-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-radius: 50%;
            z-index: 1000;
        }

        .settings-icon:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-icon svg {
            width: 24px;
            height: 24px;
        }

        .main-title {
            font-size: 48px;
            font-weight: 400;
            margin-bottom: 16px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .main-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-weight: 400;
        }

        /* Main Messages Area */
        .main-messages {
            margin: 20px auto;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-messages .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
        }

        .main-messages .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .main-messages .avatar.user {
            background: var(--accent-primary);
            color: white;
        }

        .main-messages .avatar.ai {
            background: var(--accent-primary);
            color: white;
        }

        .main-messages .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 16px 20px;
            flex: 1;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .main-messages .message.user .message-content {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .main-messages .message.ai .message-content {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }



        /* Clear Chat Button */
        .clear-chat-container {
            text-align: center;
            margin: 15px 0 40px 0;
        }

        .clear-chat-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .clear-chat-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Input Container */
        .input-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin: 0 auto 40px auto;
        }

        .input-field {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 24px;
            padding: 16px 20px;
            padding-right: 120px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .input-field:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }



        .input-right-icons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .send-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .send-button:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }

        .voice-icon {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .voice-icon svg {
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .voice-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .image-icon {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .image-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .image-icon svg {
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .voice-icon.listening {
            background: var(--accent-primary);
            color: white;
            animation: pulse-voice 1.5s infinite;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .voice-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .voice-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Image Preview Modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal.show {
            display: flex;
        }

        .image-preview-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--dark-border);
        }

        .image-preview-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
        }

        .close-preview {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .close-preview:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .image-preview-body {
            padding: 20px;
            text-align: center;
        }

        .image-preview-body img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .image-upload-info {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .image-upload-info p {
            margin: 8px 0;
        }

        .image-preview-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 20px;
            border-top: 1px solid var(--dark-border);
        }

        .remove-image-btn, .keep-image-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-speed) var(--transition-ease);
        }

        .remove-image-btn {
            background: #dc3545;
            color: white;
        }

        .remove-image-btn:hover {
            background: #c82333;
        }

        .keep-image-btn {
            background: var(--accent-primary);
            color: white;
        }

        .keep-image-btn:hover {
            background: var(--accent-secondary);
        }



        @keyframes pulse-voice {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }





                /* Chat Messages (Hidden by default) */
        .chat-container {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 64px;
            min-height: calc(100vh - 64px);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
        }



        .chat-header h2 {
            color: var(--text-primary);
            margin: 0;
        }

        .chat-messages {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
        }

        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .avatar.user {
            background: var(--accent-primary);
            color: white;
        }

        .avatar.ai {
            background: var(--accent-primary);
            color: white;
        }
        
        .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 16px 20px;
            color: var(--text-primary);
            flex: 1;
            word-wrap: break-word;
            line-height: 1.5;
            max-width: 100%;
        }

        .message.user .message-content {
            background: var(--accent-primary);
            color: white;
            border: none;
        }







        body.light-mode .message-content {
            background: var(--light-bg-tertiary);
            border-color: var(--light-border);
            color: var(--light-text-primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .input-field {
                padding-right: 100px;
            }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }



        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 12px 16px;
            margin: 0 auto;
            max-width: 600px;
            width: 100%;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        .typing-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        /* Typing indicator within message content */
        .message-content.typing-indicator {
            background: var(--bg-tertiary);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-content.typing-indicator .typing-dots {
            display: flex;
            gap: 3px;
        }

        .message-content.typing-indicator .typing-dots span {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .message-content.typing-indicator .typing-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        /* Real-time Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Real-time Message Animations */
        .message {
            animation: slideIn 0.3s ease-out;
        }

        .message.ai {
            animation: slideIn 0.4s ease-out;
        }

        /* Live Data Updates */
        .live-data {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            animation: fadeIn 0.5s ease-in;
        }

        .live-data.updating {
            background: rgba(255, 165, 0, 0.1);
            border-color: rgba(255, 165, 0, 0.3);
        }








    </style>
</head>
<body>
    <!-- Voice Status Indicator -->
    <div class="voice-status" id="voiceStatus">Listening...</div>
    

    
    <!-- Hidden File Input for Image Upload -->
    <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
    


    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <div class="image-preview-content">
            <div class="image-preview-header">
                <h3>Image Preview</h3>
                <button class="close-preview" onclick="closeImagePreview()">×</button>
            </div>
            <div class="image-preview-body">
                <img id="previewImage" src="" alt="Preview">
                <div class="image-upload-info">
                    <p>Image uploaded successfully!</p>
                    <p>You can now ask questions about this image.</p>
                </div>
            </div>
            <div class="image-preview-actions">
                <button class="remove-image-btn" onclick="removeUploadedImage()">Remove Image</button>
                <button class="keep-image-btn" onclick="closeImagePreview()">Keep Image</button>
            </div>
        </div>
    </div>
    




            <!-- Main Content Area -->
        <div class="main-content">
            <div class="header-container">
                <div class="header-left">
                    <h1 class="main-title">Query AI</h1>
                    <p class="main-subtitle">Ask detailed questions for better responses</p>
                </div>
                <div class="settings-icon" onclick="openSettings()" title="Settings">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="6" r="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <circle cx="12" cy="18" r="2"/>
                    </svg>
                </div>
            </div>
            
            <!-- Main Messages Area -->
            <div class="main-messages" id="mainMessages"></div>
            
            <!-- Input Container -->
            <div class="input-container">
                <input type="text" id="messageInput" class="input-field" placeholder="Ask anything" onkeypress="handleKeyPress(event)">
                <div class="input-right-icons">
                    <div class="image-icon" onclick="triggerImageUpload()" title="Upload Image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </div>
                    <div class="voice-icon" onclick="startVoiceInput()" title="Voice Input">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                    </div>
                    <button class="send-button" onclick="sendMessage()">↑</button>
                </div>
            </div>
            
            <!-- Clear Chat Button -->
            <div class="clear-chat-container">
                <button class="clear-chat-btn" onclick="clearChatHistory()" title="Clear conversation history">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13H5v-2h14v2z"/>
                    </svg>
                    Clear Chat
                </button>
            </div>
            <!-- Footer -->
        </div>

        <!-- Chat Container (Hidden by default) -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h2>Query AI Chat</h2>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="input-container">
            <input type="text" id="chatInput" class="input-field" placeholder="Ask anything" onkeypress="handleChatKeyPress(event)">
            <div class="input-right-icons">
                <div class="image-icon" onclick="triggerImageUpload()" title="Upload Image">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"/>
                    </svg>
                </div>
                <div class="voice-icon" onclick="startVoiceInput()" title="Voice Input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </div>
                <button class="send-button" onclick="sendChatMessage()">↑</button>
            </div>
        </div>
    </div>



    <script>
        // Global variables
        let useMemory = true;








        // Handle key press in main input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Handle key press in chat input
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }



        // Send message from chat input
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Send to AI with image if available
            if (uploadedImage && uploadedImageData) {
                sendToAIWithImage(message, uploadedImageData);
            } else {
                sendToAI(message);
            }
        }

        // Show chat view
        function showChatView() {
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
        }









        // Add message to main page
        function addMainMessage(content, isUser = false) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            mainMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            mainMessages.scrollTop = mainMessages.scrollHeight;
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to AI with image
        async function sendToAIWithImage(message, imageData) {
            try {
                // Show loading message on main page
                addMainMessage('Analyzing image and processing your question...', false);
                
                const response = await fetch('/api/chat-with-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        image_data: imageData,
                        use_memory: useMemory
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.response) {
                        // Remove loading message and add AI response to main page
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage(data.response, false);
                    } else {
                        const mainMessages = document.getElementById('mainMessages');
                        if (mainMessages.lastChild) {
                            mainMessages.removeChild(mainMessages.lastChild);
                        }
                        addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
                    }
                } else {
                    const mainMessages = document.getElementById('mainMessages');
                    if (mainMessages.lastChild) {
                        mainMessages.removeChild(mainMessages.lastChild);
                    }
                    addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
                }
            } catch (error) {
                console.error('Error with image analysis:', error);
                const mainMessages = document.getElementById('mainMessages');
                if (mainMessages.lastChild) {
                    mainMessages.removeChild(mainMessages.lastChild);
                }
                addMainMessage('Sorry, I encountered an error analyzing the image. Please try again.', false);
            }
        }

        // Send message to AI (using default GPT-4o)
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        personality: 'default',
                        use_memory: true,
                        provider: 'openai',
                        model: 'gpt-4o'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Voice input functionality
        let recognition = null;
        let isListening = false;

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                stopVoiceInput();
                return;
            }

            // Debug input fields before starting
            debugInputFields();

            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Start listening
            recognition.start();
            isListening = true;
            updateVoiceIcon(true);
            showVoiceStatus('Listening... Speak now!');

            // Set up event handlers
            recognition.onstart = function() {
                console.log('Voice recognition started');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Voice input:', transcript);
                
                // Determine which input field should receive the transcript
                let targetInput = null;
                
                // Check if we're in chat view or main view
                const chatContainer = document.getElementById('chatContainer');
                const mainContent = document.querySelector('.main-content');
                
                if (chatContainer && chatContainer.style.display !== 'none') {
                    // We're in chat view, use chatInput
                    targetInput = document.getElementById('chatInput');
                } else if (mainContent && mainContent.style.display !== 'none') {
                    // We're in main view, use messageInput
                    targetInput = document.getElementById('messageInput');
                }
                
                // If we found a target input, fill it with the transcript
                if (targetInput) {
                    targetInput.value = transcript;
                    targetInput.focus(); // Focus the input field
                    showVoiceStatus(`"${transcript}" - Ready to send!`);
                    console.log('Transcript added to:', targetInput.id);
                } else {
                    console.error('No target input found for transcript');
                    showVoiceStatus('Error: Could not find input field');
                }
                
                // Stop listening
                stopVoiceInput();
            };

            recognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);
                let errorMessage = 'Voice recognition error';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'No speech detected. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microphone not accessible. Please check permissions.';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied. Please allow microphone access.';
                        break;
                    default:
                        errorMessage = `Voice recognition error: ${event.error}`;
                }
                
                showVoiceStatus(errorMessage);
                stopVoiceInput();
            };

            recognition.onend = function() {
                console.log('Voice recognition ended');
                stopVoiceInput();
            };
        }

        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            isListening = false;
            updateVoiceIcon(false);
        }

        function updateVoiceIcon(listening) {
            const voiceIcons = document.querySelectorAll('.voice-icon');
            voiceIcons.forEach(icon => {
                if (listening) {
                    icon.classList.add('listening');
                    // Replace SVG with red dot when listening
                    icon.innerHTML = '<div style="width: 12px; height: 12px; background: white; border-radius: 50%;"></div>';
                } else {
                    icon.classList.remove('listening');
                    // Restore SVG icon when not listening
                    icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';
                }
            });
        }

        function showVoiceStatus(message) {
            const status = document.getElementById('voiceStatus');
            status.textContent = message;
            status.classList.add('show');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        function hideVoiceStatus() {
            const status = document.getElementById('voiceStatus');
            status.classList.remove('show');
        }

        // Image upload functionality
        let uploadedImage = null;
        let uploadedImageData = null;

        function triggerImageUpload() {
            document.getElementById('imageUploadInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Image file size must be less than 10MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = file;
                uploadedImageData = e.target.result;
                
                // Show image preview
                document.getElementById('previewImage').src = uploadedImageData;
                document.getElementById('imagePreviewModal').classList.add('show');
                
                // Update input placeholder to indicate image is ready
                updateInputPlaceholders();
                
                console.log('Image uploaded:', file.name, file.size, 'bytes');
            };
            reader.readAsDataURL(file);
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('show');
        }

        function removeUploadedImage() {
            uploadedImage = null;
            uploadedImageData = null;
            document.getElementById('imageUploadInput').value = '';
            document.getElementById('imagePreviewModal').classList.remove('show');
            updateInputPlaceholders();
            console.log('Image removed');
        }

        function updateInputPlaceholders() {
            const messageInput = document.getElementById('messageInput');
            const chatInput = document.getElementById('chatInput');
            
            if (uploadedImage) {
                const placeholder = `Ask about the uploaded image... (${uploadedImage.name})`;
                if (messageInput) messageInput.placeholder = placeholder;
                if (chatInput) chatInput.placeholder = placeholder;
            } else {
                if (messageInput) messageInput.placeholder = 'Ask anything';
                if (chatInput) chatInput.placeholder = 'Ask anything';
            }
        }

        // Pixel Dog Interactions
        function initPixelDog() {
            const dog = document.getElementById('pixelDog');
            const speechBubble = document.getElementById('dogSpeechBubble');
            
            // Make dog interactive
            dog.style.pointerEvents = 'auto';
            dog.style.cursor = 'pointer';
            
            // Dog click interactions
            dog.addEventListener('click', function() {
                // Random dog reactions
                const reactions = [
                    'Woof! 🐕',
                    'Happy to see you! 🐾',
                    'Want to play? 🎾',
                    'Good human! 👋',
                    'Sniff sniff... 👃'
                ];
                
                const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
                speechBubble.querySelector('.bubble-text').textContent = randomReaction;
                
                // Add excitement animation
                dog.style.animation = 'dog-bounce 0.5s ease-in-out 3';
                setTimeout(() => {
                    dog.style.animation = 'dog-bounce 3s ease-in-out infinite';
                }, 1500);
                
                // Reset to original message after 3 seconds
                setTimeout(() => {
                    speechBubble.querySelector('.bubble-text').textContent = 'Thank you for visiting my app! 🐕✨';
                }, 3000);
            });
            
            // Dog hover effects
            dog.addEventListener('mouseenter', function() {
                dog.style.transform = 'scale(1.1)';
                speechBubble.style.transform = 'scale(1.05)';
            });
            
            dog.addEventListener('mouseleave', function() {
                dog.style.transform = 'scale(1)';
                speechBubble.style.transform = 'scale(1)';
            });
        }

        // Debug function to check input field states
        function debugInputFields() {
            const chatContainer = document.getElementById('chatContainer');
            const mainContent = document.querySelector('.main-content');
            const chatInput = document.getElementById('chatInput');
            const messageInput = document.getElementById('messageInput');
            
            console.log('=== Input Field Debug ===');
            console.log('Chat container display:', chatContainer ? chatContainer.style.display : 'not found');
            console.log('Main content display:', mainContent ? mainContent.style.display : 'not found');
            console.log('Chat input exists:', !!chatInput);
            console.log('Message input exists:', !!messageInput);
            console.log('Chat input value:', chatInput ? chatInput.value : 'N/A');
            console.log('Message input value:', messageInput ? messageInput.value : 'N/A');
            console.log('========================');
        }

        // Test backend connection
        async function testBackend() {
            try {
                const response = await fetch('/debug');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend test successful:', data);
                    return true;
                } else {
                    console.error('Backend test failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Backend test error:', error);
                return false;
            }
        }

        // Send message to AI (using default GPT-4o)
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        personality: 'default',
                        use_memory: true,
                        provider: 'openai',
                        model: 'gpt-4o'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Send message to AI with image (using default GPT-4o)
        async function sendToAIWithImage(message, imageData) {
            try {
                const response = await fetch('/api/chat-with-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        image_data: imageData,
                        personality: 'default',
                        use_memory: true
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addMainMessage(data.response, false);
                    
                    // Real-time model info for image analysis
                    const modelInfo = document.createElement('div');
                    modelInfo.className = 'model-indicator';
                    modelInfo.innerHTML = `
                        <small style="color: #3B82F6; font-size: 12px; opacity: 0.8;">
                            Powered by GPT-4o (Image Analysis) • ${data.tokens_used || 0} tokens
                        </small>
                    `;
                    
                    const lastMessage = document.querySelector('.main-messages .message.ai:last-child');
                    if (lastMessage) {
                        lastMessage.appendChild(modelInfo);
                    }
                } else {
                    addMainMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMainMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Test backend connection
            testBackend();
        });

        // Real-time Updates System





        function updateLiveData() {
            // Keep this function for future use but don't auto-fetch data
            // Data will be fetched when users ask specific questions
        }





        // Clear Chat History
        function clearChatHistory() {
            const mainMessages = document.getElementById('mainMessages');
            mainMessages.innerHTML = '';
        }

        // Typing Indicator Functions
        function showTypingIndicator() {
            const mainMessages = document.getElementById('mainMessages');
            
            // Create typing indicator as an AI message
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing-message';
            typingDiv.id = 'typingMessage';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar ai';
            avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                <!-- Robot Head -->
                <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                <!-- Eyes -->
                <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                <!-- Smiling Mouth -->
                <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                <!-- Headset Band -->
                <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                <!-- Earcups -->
                <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                <!-- Microphone -->
                <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                <!-- Antenna -->
                <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
            </svg>`;
            
            const typingContent = document.createElement('div');
            typingContent.className = 'message-content typing-indicator';
            typingContent.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">AI is thinking...</span>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            mainMessages.appendChild(typingDiv);
            
            // Scroll to bottom
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        function hideTypingIndicator() {
            const typingMessage = document.getElementById('typingMessage');
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        // Enhanced Message Functions with Real-time Features
        function addMainMessage(content, isUser = false) {
            const mainMessages = document.getElementById('mainMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? 'user' : 'ai'}`;
            if (isUser) {
                avatar.textContent = '👤';
            } else {
                avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFFFFF">
                    <!-- Robot Head -->
                    <ellipse cx="12" cy="10" rx="8" ry="6" fill="#FFFFFF"/>
                    <!-- Eyes -->
                    <circle cx="9" cy="8" r="1.5" fill="#3B82F6"/>
                    <circle cx="15" cy="8" r="1.5" fill="#3B82F6"/>
                    <!-- Smiling Mouth -->
                    <path d="M9 12 Q12 15 15 12" stroke="#3B82F6" stroke-width="1.5" fill="none"/>
                    <!-- Headset Band -->
                    <path d="M4 10 Q12 4 20 10" stroke="#FFFFFF" stroke-width="2" fill="none"/>
                    <!-- Earcups -->
                    <circle cx="4" cy="10" r="2" fill="#FFFFFF"/>
                    <circle cx="20" cy="10" r="2" fill="#FFFFFF"/>
                    <!-- Microphone -->
                    <path d="M2 10 Q0 12 0 15" stroke="#FFFFFF" stroke-width="1.5" fill="none"/>
                    <circle cx="0" cy="15" r="1" fill="#FFFFFF"/>
                    <!-- Antenna -->
                    <line x1="12" y1="4" x2="12" y2="1" stroke="#FFFFFF" stroke-width="1.5"/>
                    <circle cx="12" cy="1" r="1" fill="#FFFFFF"/>
                </svg>`;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            mainMessages.appendChild(messageDiv);
            
            // Real-time scroll with smooth animation
            mainMessages.scrollTo({
                top: mainMessages.scrollHeight,
                behavior: 'smooth'
            });
            

        }

        // Enhanced Send Message with Real-time Features
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to main page (keep conversation history)
            addMainMessage(message, true);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send to AI with image if available
            if (uploadedImage && uploadedImageData) {
                await sendToAIWithImage(message, uploadedImageData);
            } else {
                await sendToAI(message);
            }
            
            // Hide typing indicator
            hideTypingIndicator();
        }

        // Settings function (placeholder for future implementation)
        function openSettings() {
            // TODO: Add settings functionality later
            console.log('Settings clicked - functionality to be added');
            // You can add a modal, dropdown, or navigation to settings page here
        }


    </script>
</body>
</html>
